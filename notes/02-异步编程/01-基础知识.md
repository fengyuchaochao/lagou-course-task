# 同步与异步

## 1. 何为单线程语言？

即同一时间只能执行一个任务的语言

## 2. js为什么要设计成单线程？

很显然，单线程语言，所有的任务都是排队执行，或者代码都是 从上到下同步执行，比较简洁，在js设计之初，应用场景也相对简单，所以就直接设计成了单线程。

例如，浏览器页面中的一个dom假如同时有两个线程对其操作，一个修改，一个删除，那浏览器到底以哪个为准呢？这又要设计到多线程的复杂问题，了解java等语言的可能遇到过类似线程死锁等问题，所以引入多线程，会复杂很多。

同时我们也要注意一点，我们上面提到的dom操作，并不是引入多线程就无法进行dom操作了，多线程本质上也是多个线程之间来回进行切换执行，所以，多线程肯定也是可以解决我们页面的各种dom操作问题的，只是一切从简，况且单线程是可以实现早期网页的各种交互的，所以也没必要设计成多线程。


## 3. js为什么引入异步？

上面，我们已经明确了javascript是一门单线程语言，也就意味着所有的任务都必须排队依次执行，那么，很显然这样就带来一个问题，假如前面一个任务执行了很久，依然没结束，此时后面的任务都必须等着，这样也是不合理的，那么，js为什么解决这种问题，就引入同步任务与异步任务：

* 同步任务：即从上到下同步执行的代码，
* 异步任务：即有些耗时的任务可以做成异步，这样即使该任务耗时很久，但依然不影响后面任务的执行。

```
let a = 1;
let b = 2;

//同步任务
console.log(a + b);

//异步任务
setTimeout(() => {
    console.log(a + b);
}, 1000);
```
说明：上面我们直接打印a+b，很显然就会直接执行，这一个同步任务，而setTimeout回调中的操作，需要等到1s之后才会执行，我们把这种叫做异步任务。

## 4. js有哪些常见的异步任务？

* setTimeout
* setInterval
* ajax

以上就是最常见的异步任务，还有很多其他异步任务，同时异步任务一般分为两类，宏任务与微任务，具体我们后面会详细介绍。

## 5. 浏览器是如何执行异步任务的？

![image](http://note.youdao.com/yws/res/6936/59534E53A6F84BEE92B228B5CAE978BA)

我们来结合代码和流程图理解下：

```
console.log(1);
setTimeout(() => {
    console.log(2);
}, 0)
console.log(3);
```
执行流程如下：

1. 浏览器执行第一行，console.log(1); 判断这是一个同步任务，就直接在主线程执行，打印除1
2. 遇到setTimeout(() => {console.log(2)}, 0) 判断这是一个异步任务，于是就把整个异步任务放到了Event Table里，然后等到setTimeout指定的时间以后，会把setTimeout回调方法里的任务push到Event Queue中。
3. 然后继续执行console.log(3)，判断这是一个同步任务，于是直接打印出2
4. 至此，主线程的任务已全部执行完。
5. 等到主线程的任务执行完毕以后，判断Event Queue中是否还有任务，发现还有一个console.log(2); 于是执行该任务，打印出2
6. 最后结果依次打印出：1 3 2


以上执行过程中还包含一些细节，我们要强调一下：

1. Event Table中存放到是setTimeout(() => {console.log(2)}, 0), Event Queue中存放到是setTimeout回调函数中的console.log(2).
2. setTimeout设置0s，并不会说明假如到Event Table以后，就立即将其回调函数中的任务放到了Event Queue， 因为其实浏览器中有一个最小时间，大概是4毫秒，所以即使设置了0s，但依然会在4毫秒之后，才会将回调函数中的任务加入到Event Queue中。
3. 例如setTimeout设置了2s后执行，它就真的会在2s后准时执行吗？其实不会，2s只是说明在2s之后把setTimeout的回调函数中的任务放到了Event Queue中，真正执行还要等到主线程执行完成以后，才会执行event Queue中的任务。

总结来说：浏览器提供了一套事件循环(Event Loop)机制，来执行异步任务。


## 深入理解EventLoop机制

![image](http://note.youdao.com/yws/res/8959/DA82761CEED54BE7937DB27307EFF1C7)

注意点：
1. javascript代码本身是单线程的，而遇到setTimeout等异步任务，这个时候回交给浏览器的异步调用线程去执行异步任务（注意：这里的线程是浏览器提供的单独的一个线程，来处理异步任务，这和javascript是单线程语言并不矛盾）。
2. 回调函数，异步方案的根基，深入理解一下回调函数，所谓回调函数，其实就是异步任务执行完成以后所调用的函数，它是调用者定义，交给执行者执行
